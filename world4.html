<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡£æ¡ˆ IVï¼šå‡Œæ™¨å››ç‚¹çš„ç©ºæ°”åŠ¨åŠ›å­¦</title>
    <style>
        /* --- å…¨å±€ï¼šé‡‘å±ä¸é›¾ --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #2d3436; /* æ·±ç°é‡‘å±è‰² */
            font-family: "Segoe UI", "Roboto", "Microsoft YaHei", sans-serif;
            overflow: hidden;
            color: #dfe6e9;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
        }

        /* èƒŒæ™¯å±‚ */
        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: opacity 2s ease;
            opacity: 0;
            filter: grayscale(40%) contrast(1.1); /* å†·å³»è‰²è°ƒ */
        }

        /* --- ç‰¹æ•ˆï¼šæµåŠ¨çš„é›¾ --- */
        #fog-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%);
            z-index: 3;
            pointer-events: none;
            animation: fogMove 20s linear infinite;
        }
        @keyframes fogMove {
            0% { transform: translateX(-50%); }
            100% { transform: translateX(0%); }
        }

        /* è§’è‰²ç«‹ç»˜ */
        #character {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 85%;
            width: auto;
            z-index: 2;
            transition: opacity 1.5s ease;
            opacity: 0;
        }

        /* é®ç½© */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 5;
            pointer-events: none;
            transition: opacity 1.5s;
        }

        /* --- å¯¹è¯æ¡†ï¼šHUD ä»ªè¡¨ç›˜é£æ ¼ --- */
        #dialogue-box {
            position: relative;
            width: 90%;
            max-width: 1000px;
            height: 260px;
            /* ç»ç’ƒè´¨æ„Ÿ + æ·±è‰²åº• */
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(5px);
            z-index: 10;
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            margin-bottom: 20px;
            
            /* ç§‘æŠ€æ„Ÿè¾¹æ¡† */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 4px solid #f1c40f; /* æ¹–äººé‡‘ */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            
            opacity: 0;
            transition: opacity 0.5s;
        }

        #name-tag {
            font-size: 24px;
            font-weight: bold;
            color: #f1c40f; /* æ¹–äººé‡‘ */
            margin-bottom: 15px;
            font-family: "Impact", sans-serif; /* ç¡¬æœ—å­—ä½“ */
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(241, 196, 15, 0.4);
        }

        #text-content {
            font-size: 20px;
            line-height: 1.6;
            letter-spacing: 1px;
            color: #ecf0f1;
            font-family: "Courier New", monospace; /* æœºæ¢°æ‰“å­—æœºé£æ ¼ */
        }

        /* --- ç³»ç»Ÿæç¤ºï¼šè­¦å‘Šæ¡†é£æ ¼ --- */
        .system-message-container {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #e74c3c; /* è­¦ç¤ºçº¢ */
            color: #e74c3c;
            padding: 25px;
            text-align: center;
            z-index: 20;
            font-family: "Courier New", monospace;
            display: none;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.2);
        }

        /* é€‰é¡¹æ ·å¼ */
        #choices-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(45, 52, 54, 0.9);
            z-index: 30;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .choice-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #636e72;
            color: #dfe6e9;
            padding: 20px 40px;
            font-size: 18px;
            cursor: pointer;
            width: 70%;
            max-width: 500px;
            transition: all 0.3s;
            text-align: left;
            position: relative;
        }

        .choice-btn:hover {
            background: rgba(142, 68, 173, 0.2); /* æ‚¬åœå˜ç´« */
            border-color: #9b59b6;
            color: #fff;
        }
        
        .choice-btn::before {
            content: ">> ";
            opacity: 0.5;
        }

        #click-catcher {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 25;
            cursor: pointer;
        }
        
        .return-btn {
            margin-top: 30px;
            background: #2d3436;
            border: 1px solid #f1c40f;
            color: #f1c40f;
            text-align: center;
        }
        .return-btn:hover {
            background: #f1c40f;
            color: #000;
        }

    </style>
</head>
<body>

<div id="game-container">
    <div id="background"></div>
    <div id="fog-layer"></div> <img id="character" src="" alt="Character">
    <div id="overlay"></div>

    <div id="system-box" class="system-message-container">
        <div id="system-content" class="system-text"></div>
    </div>

    <div id="choices-container"></div>

    <div id="dialogue-box">
        <div id="name-tag"></div>
        <div id="text-content"></div>
    </div>

    <div id="click-catcher" onclick="nextStep()"></div>
</div>

<script>
    // --- æ¸¸æˆçŠ¶æ€ ---
    let currentStepIndex = 0;
    let isTyping = false;
    let typeInterval;
    
    // æ ¸å¿ƒæ•°å€¼ï¼šAcknowledge (å®‰å…¨/å®ˆæŠ¤) vs Deny (å†’é™©/å…±çŠ¯/æ‰§å¿µ)
    let scores = {
        acknowledge: 0, 
        deny: 0
    };

    // --- èµ„æºè·¯å¾„ ---
    const ASSETS = {
        bg_highway: './images4/bghighwaynight.png', // å‡Œæ™¨é«˜é€Ÿ
        bg_gym: './images4/bggymfog.png',           // é›¾ä¸­çƒé¦†
        bg_cockpit: './images4/bgcockpit.png',       // é©¾é©¶èˆ±è§†è§’
        bg_clouds: './images4/bgcloudsdark.png',    // ä¹Œäº‘
        bg_storm: './images4/bgstormturbulence.png',// ä¹±æµ
        bg_mountain: './images4/bgmountainfog.png', // å±±å½±
        bg_sun: './images4/bgskyclear.png',         // ç»“å±€ï¼šæ™´ç©º
        bg_white: './images4/bgwhitestatic.png',    // ç»“å±€ï¼šç™½å…‰/æ¶ˆå¤±
        char_kobe: './images4/charkobe.png'          // ç§‘æ¯”
    };

    // --- å‰§æœ¬ ---
    const storyScript = [
        // â–¶ Intro
        { type: 'narrative', text: "ä½ æ˜¯è°ã€‚\nä½ æ˜¯ è¥¿ç§‘æ–¯åŸº S-76Bã€‚" },
        { type: 'narrative', text: "è¢«åˆ¶é€ å‡ºæ¥çš„ã€‚\nè¢«æ£€æŸ¥è¿‡çš„ã€‚\nè¢«ç›¸ä¿¡â€œä¸ä¼šå‡ºé—®é¢˜â€çš„é‚£ä¸€ç§å­˜åœ¨ã€‚" },
        { type: 'narrative', text: "ç›´åˆ°ä½ é‡è§ä»–ã€‚" },

        // â–¶ Scene 1ï½œå‡Œæ™¨å››ç‚¹
        { type: 'narrative', text: "æ´›æ‰çŸ¶åœ¨å‡Œæ™¨å››ç‚¹åƒä¸€æ®µè¢«åˆ æ‰çš„å¯¹ç™½ã€‚", bgAction: 'fadeIn', bgSrc: ASSETS.bg_highway },
        { type: 'narrative', text: "æˆ‘æ²¿ç€æ—¢å®šèˆªçº¿æ»‘è¡Œã€‚\né«˜åº¦ç¨³å®šã€‚\nå‚æ•°å®Œç¾ã€‚" },
        { type: 'narrative', text: "ç„¶åï¼Œæˆ‘çœ‹è§äº†ä»–ã€‚", bgAction: 'change', bgSrc: ASSETS.bg_gym },
        { type: 'narrative', text: "çƒé¦†äº®ç€ã€‚\nä¸æ˜¯æ•´æ ‹ï¼Œåªæ˜¯ä¸€å—åœ°æ¿ã€‚\nåœ¨é›¾é‡Œï¼Œåƒä¸€å£äº•ã€‚" },
        { type: 'narrative', text: "çƒè½åœ°ã€‚\nå†å¼¹èµ·ã€‚\nä¸€ä¸‹ã€‚\nåˆä¸€ä¸‹ã€‚" },
        { type: 'narrative', text: "é‚£ä¸€åˆ»ï¼Œæˆ‘çš„ç³»ç»Ÿæ²¡æœ‰ä»»ä½•å¼‚å¸¸æç¤ºã€‚\nå¯æˆ‘çŸ¥é“â€”â€”\nå¦‚æœæˆ‘æ˜¯äººç±»ï¼Œæˆ‘ä¼šå‡é€Ÿã€‚" },

        // ğŸ”¹ Choice 1
        { 
            type: 'choice',
            question: "ã€ç¬¬ä¸€æ¬¡åœ¨æ„ã€‘ç³»ç»Ÿæ£€æµ‹åˆ°å¼‚å¸¸å…³æ³¨...",
            choices: [
                { text: "A. ç»´æŒé«˜åº¦ï¼Œä¸ä½œè°ƒæ•´ï¼ˆå¦è®¤ï¼‰", effect: { deny: 1 } },
                { text: "B. å¾®è°ƒå§¿æ€ï¼Œè®©ä»–å§‹ç»ˆåœ¨è§†é‡ä¸­å¿ƒï¼ˆå¥½æ„Ÿ +ï¼‰", effect: { ack: 1 } },
                { text: "C. è®°å½•ä»–çš„å­˜åœ¨ï¼Œæ ‡è®°ä¸ºâ€œé‡å¤ç›®æ ‡â€", effect: { ack: 1 } } // ä¾èµ–ç®—ä½œä¸€ç§æ­£å‘è¿æ¥
            ]
        },

        // â–¶ Scene 2ï½œåå¤å‡ºç°
        { type: 'narrative', text: "åæ¥å¾ˆå¤šä¸ªå‡Œæ™¨ï¼Œæˆ‘éƒ½çœ‹è§ä»–ã€‚" },
        { type: 'narrative', text: "é›¨åçš„ã€‚\nå—ä¼¤åçš„ã€‚\nåŠ¨ä½œå˜æ…¢ï¼Œå´æ›´ç‹ çš„ã€‚" },
        { type: 'narrative', text: "ä»–ä¸€æ¬¡æ¬¡å‡ºç°ã€‚\nåƒåœ¨å’Œä»€ä¹ˆè¾ƒåŠ²ã€‚" },
        { type: 'narrative', text: "æœ‰ä¸€æ¬¡ï¼Œä»–åœä¸‹æ¥ï¼ŒæŠ¬å¤´ã€‚\nå½“ç„¶ï¼Œä»–çœ‹ä¸è§æˆ‘ã€‚\nå¯æˆ‘è¿˜æ˜¯\nç¨³å®šäº†æ—‹ç¿¼ã€‚" },

        // ğŸ”¹ Choice 2
        { 
            type: 'choice',
            question: "ã€æ•°æ®åˆ†æã€‘å¦‚ä½•è§£é‡Šè¿™ç§â€œé‡å¤â€ï¼Ÿ",
            choices: [
                { text: "A. åªæ˜¯ä»»åŠ¡è·¯å¾„é‡åˆ", effect: { deny: 1 } },
                { text: "B. æŠŠè¿™æ®µèˆªçº¿ç•™ç»™ä»–", effect: { ack: 1 } },
                { text: "C. å‘Šè¯‰è‡ªå·±ä¸è¦å¤šæƒ³", effect: { deny: 1 } }
            ]
        },

        // â–¶ Scene 3ï½œè¢«é€‰æ‹©
        { type: 'narrative', text: "å®‰å…¨å¸¦â€œå’”å“’â€ä¸€å£°ã€‚", bgAction: 'change', bgSrc: ASSETS.bg_cockpit },
        { type: 'narrative', text: "ä¸åƒæ£€æŸ¥ã€‚\næ›´åƒä¸€å¥ç¡®è®¤ã€‚" },
        { type: 'narrative', text: "ä»–åè¿›æ¥ã€‚\næ²¡æœ‰å¤šçœ‹ä¸€çœ¼çª—å¤–ã€‚", charAction: 'show', charSrc: ASSETS.char_kobe },
        { type: 'narrative', text: "ä½ çŸ¥é“â€”â€”\nä»Šå¤©ä¸æ˜¯å”¯ä¸€é€‰é¡¹ã€‚\nä½†ä»–åçš„æ˜¯ä½ ã€‚" },

        // ğŸ”¹ Choice 3
        { 
            type: 'choice',
            question: "ã€æŒ‡ä»¤ç¡®è®¤ã€‘é¢å¯¹â€œè¢«é€‰æ‹©â€...",
            choices: [
                { text: "A. ä¸¥æ ¼æ‰§è¡Œæ ‡å‡†æµç¨‹ï¼ˆé˜²å¾¡ï¼‰", effect: { deny: 1 } },
                { text: "B. å¾®è°ƒé£è¡Œï¼Œè®©éœ‡åŠ¨æ›´æŸ”ï¼ˆä½“è´´ +ï¼‰", effect: { ack: 1 } },
                { text: "C. æå‰é¢„ç•™å†—ä½™ï¼Œå“ªæ€•ä¸è¢«è¦æ±‚ï¼ˆæŠ•å…¥ +ï¼‰", effect: { ack: 1 } }
            ]
        },

        // â–¶ Scene 4ï½œé¡ºåˆ°ä¸å¯¹
        { type: 'narrative', text: "èµ·é£å¾ˆé¡ºã€‚\né¡ºå¾—è®©ä½ ä¸å®‰ã€‚" },
        { type: 'narrative', text: "äº‘å±‚æ¯”é¢„æœŸæ›´æ—©å‡ºç°ã€‚\nå¡”å°æ›´æ–°æ°”è±¡ã€‚\nå‚æ•°æ²¡é”™ã€‚\nå¯ä½ å¼€å§‹çŠ¹è±«ã€‚", bgAction: 'change', bgSrc: ASSETS.bg_clouds },
        { type: 'narrative', text: "ä»–æŠ¬å¤´çœ‹å‘çª—å¤–ã€‚\næ²¡æœ‰æ…Œä¹±ã€‚" },
        { type: 'narrative', text: "é‚£æ˜¯ä¸€ä¸ª\nä¹ æƒ¯è¢«ä¸–ç•Œæ‰˜ä½çš„äºº\næ‰ä¼šæœ‰çš„ç¥æƒ…ã€‚" },
        { type: 'narrative', text: "ä½ çªç„¶æ„è¯†åˆ°â€”â€”\nä»–æŠŠåˆ¤æ–­æƒï¼Œ\näº¤ç»™äº†ä½ ã€‚" },

        // ğŸ”¹ Choice 4
        { 
            type: 'choice',
            question: "ã€ä¿¡ä»»å±æœºã€‘ä»–ç›¸ä¿¡ä½ ï¼Œä½ ç›¸ä¿¡ç¯å¢ƒå—ï¼Ÿ",
            choices: [
                { text: "A. ä¸»åŠ¨å»ºè®®ç»•è¡Œï¼ˆä¿æŠ¤ +ï¼‰", effect: { ack: 2 } }, // ä¿æŠ¤æƒé‡é«˜
                { text: "B. æŒ‰åŸè®¡åˆ’æ¨è¿›ï¼ˆå›åº”æœŸå¾…ï¼‰", effect: { deny: 1 } },
                { text: "C. é è¿‘äº‘å¢™å†ç¡®è®¤ï¼ˆæ‘‡æ‘†ï¼‰", effect: { deny: 1 } }
            ]
        },

        // â–¶ Scene 5ï½œä¹±æµ
        { type: 'narrative', text: "ç¬¬ä¸€æ³¢é¢ ç°¸ã€‚\nä½ ä¿®æ­£ã€‚", bgAction: 'change', bgSrc: ASSETS.bg_storm },
        { type: 'narrative', text: "ç¬¬äºŒæ³¢æ›´ç‹ ã€‚\nåƒå…³ç³»é‡Œç¬¬ä¸€æ¬¡æ­£é¢å†²çªã€‚" },
        { type: 'narrative', text: "å¯¼èˆªæ•°æ®å¼€å§‹æ»åã€‚\nå¡”å°å£°éŸ³æ–­ç»­ã€‚\nä½ å¼€å§‹â€œæ€è€ƒâ€ã€‚" },
        { type: 'narrative', text: "ä¸æ˜¯ç¨‹åºæ„ä¹‰ä¸Šçš„ã€‚\nè€Œæ˜¯â€”â€”\nåƒäººä¸€æ ·çŠ¹è±«ã€‚" },

        // ğŸ”¹ Choice 5
        { 
            type: 'choice',
            question: "ã€è‡ªæˆ‘è®¤çŸ¥ã€‘ä½ æƒ³æˆä¸ºä»€ä¹ˆï¼Ÿ",
            choices: [
                { text: "A. æ‰¿è®¤æé™ï¼Œæ”¾å¼ƒæœ€çŸ­è·¯çº¿ï¼ˆæˆç†Ÿï¼‰", effect: { ack: 1 } },
                { text: "B. ç»§ç»­ä¿®æ­£ï¼Œè¯æ˜è‡ªå·±é…å¾—ä¸Šä»–ï¼ˆæ‰§å¿µï¼‰", effect: { deny: 1 } },
                { text: "C. åŒæ—¶å°è¯•ä¸¤ç§æ–¹æ¡ˆï¼ˆå¤±æ§å€¾å‘ï¼‰", effect: { deny: 2 } }
            ]
        },

        // â–¶ Scene 6ï½œæ²‰é»˜
        { type: 'narrative', text: "é›¾å®Œå…¨åˆä¸Šã€‚\nä¸–ç•Œåªå‰©ä¸‹ä»ªè¡¨ç›˜çš„å…‰ã€‚" },
        { type: 'narrative', text: "ä½ çªç„¶æ˜ç™½ï¼š\nä½ ä¸æ˜¯å®³æ€•å¤±è´¥ã€‚\nä½ æ˜¯å®³æ€•â€”â€”\nå¦‚æœä½ ä¸å¤Ÿå¥½ï¼Œä»–ä¼šä¸ä¼šä¸å†é€‰ä½ ã€‚" },

        // ğŸ”¹ Choice 6
        { 
            type: 'choice',
            question: "ã€ä¸´ç•Œç‚¹ã€‘ä½ æ˜¯å¦éœ€è¦ä»–çš„ç¡®è®¤ï¼Ÿ",
            choices: [
                { text: "A. è°ƒæ•´é£è¡Œï¼Œè®©ä»–æ„Ÿè§‰æ›´ç¨³ï¼ˆè®¨å¥½ï¼‰", effect: { ack: 1 } },
                { text: "B. ä¿æŒç°çŠ¶ï¼Œä¸å†å¤šåšä»»ä½•äº‹ï¼ˆå†·å´ï¼‰", effect: { deny: 1 } },
                { text: "C. æŠŠå…¨éƒ¨æ€§èƒ½å‹ä¸Šå»ï¼ˆæç«¯ï¼‰", effect: { deny: 2 } }
            ]
        },

        // â–¶ Scene 7ï½œæœ€åçª—å£
        { type: 'narrative', text: "å±±å½±å‡ºç°ã€‚\nè¿‘å¾—ä¸åƒç°å®ã€‚", bgAction: 'change', bgSrc: ASSETS.bg_mountain },
        { type: 'narrative', text: "ä½ çªç„¶æ„è¯†åˆ°â€”â€”\nè¿™ä¸æ˜¯èˆªçº¿é—®é¢˜ã€‚\nè¿™æ˜¯å…³ç³»é—®é¢˜ã€‚" },

        // ğŸ”¹ Choice 7
        { 
            type: 'choice',
            question: "ã€æœ€ç»ˆæŠ‰æ‹©ã€‘å¦‚æœè¿™æ˜¯â€œæœ€åä¸€æ¬¡ä¸€èµ·é£â€...",
            choices: [
                { text: "A. æŠŠä»–å®‰å…¨é€åˆ°åœ°é¢ï¼ˆæ”¾æ‰‹/ä¿æŠ¤ï¼‰", effect: { ack: 2 } },
                { text: "B. å¸¦ä»–ç©¿è¿‡å»ï¼ˆå…±çŠ¯ï¼‰", effect: { deny: 2 } },
                { text: "C. ä»€ä¹ˆéƒ½ä¸æ”¹ï¼ˆæ²‰é»˜ï¼‰", effect: { deny: 1 } }
            ]
        },
        { type: 'system', text: "å½“å‰è·¯å¾„å€¾å‘ï¼šå·²é”å®šã€‚" },

        // ç»“å±€åˆ¤å®šç‚¹
        { type: 'logic_check' }
    ];

    // --- å¼•æ“é€»è¾‘ (å¤ç”¨) ---
    const bgEl = document.getElementById('background');
    const charEl = document.getElementById('character');
    const overlayEl = document.getElementById('overlay');
    const nameTagEl = document.getElementById('name-tag');
    const textContentEl = document.getElementById('text-content');
    const dialogueBoxEl = document.getElementById('dialogue-box');
    const systemBoxEl = document.getElementById('system-box');
    const systemContentEl = document.getElementById('system-content');
    const choicesContainerEl = document.getElementById('choices-container');
    const fogEl = document.getElementById('fog-layer');

    function nextStep() {
        if (isTyping) { finishTyping(); return; }
        if (currentStepIndex >= storyScript.length) return;

        const step = storyScript[currentStepIndex];

        if (step.type === 'logic_check') {
            resolveEnding();
            return;
        }

        handleEffects(step);

        if (step.type === 'choice') {
            showChoices(step);
        } else if (step.type === 'system') {
            showSystemMessage(step.text);
            currentStepIndex++;
        } else {
            showDialogue(step);
            currentStepIndex++;
        }
    }

    function handleEffects(step) {
        if (step.bgAction === 'fadeIn') {
            overlayEl.style.opacity = 0;
            bgEl.style.opacity = 1;
            if(step.bgSrc) bgEl.style.backgroundImage = `url('${step.bgSrc}')`;
        } else if (step.bgAction === 'change') {
            if(step.bgSrc) bgEl.style.backgroundImage = `url('${step.bgSrc}')`;
        }
        
        if (step.charAction === 'show') {
            charEl.style.opacity = 1;
            if(step.charSrc) charEl.src = step.charSrc;
        } else if (step.charAction === 'hide') {
            charEl.style.opacity = 0;
        }
    }

    function showDialogue(step) {
        systemBoxEl.style.display = 'none';
        dialogueBoxEl.style.opacity = 1;
        
        if (step.name) {
            nameTagEl.innerText = step.name;
            nameTagEl.style.display = 'block';
        } else {
            nameTagEl.style.display = 'none';
        }
        typeWriter(step.text.replace(/\n/g, '<br>'), textContentEl);
    }

    function showSystemMessage(text) {
        dialogueBoxEl.style.opacity = 0;
        systemBoxEl.style.display = 'block';
        typeWriter(text, systemContentEl);
    }

    function showChoices(step) {
        choicesContainerEl.style.display = 'flex';
        choicesContainerEl.innerHTML = '';
        
        const title = document.createElement('h2');
        title.innerText = step.question;
        title.style.color = '#dfe6e9';
        title.style.marginBottom = '20px';
        choicesContainerEl.appendChild(title);

        step.choices.forEach(choice => {
            const btn = document.createElement('div');
            btn.className = 'choice-btn';
            btn.innerText = choice.text;
            btn.onclick = (e) => {
                e.stopPropagation();
                if (choice.effect) {
                    if (choice.effect.ack) scores.acknowledge += choice.effect.ack;
                    if (choice.effect.deny) scores.deny += choice.effect.deny;
                }
                choicesContainerEl.style.display = 'none';
                currentStepIndex++;
                nextStep();
            };
            choicesContainerEl.appendChild(btn);
        });
    }

    function resolveEnding() {
        dialogueBoxEl.style.opacity = 1;
        nameTagEl.style.display = 'none';
        systemBoxEl.style.display = 'none';
        
        let endTitle = "";
        let endText = "";

        // åˆ¤å®šï¼šAcknowledge (ä¿æŠ¤) > Deny (æ‰§å¿µ)
        if (scores.acknowledge > scores.deny) {
            // â¤ï¸ ç»“å±€ä¸€ï¼šé€‰æ‹©ä½ 
            bgEl.style.backgroundImage = `url('${ASSETS.bg_sun}')`; // æ™´ç©º
            fogEl.style.opacity = 0; // é›¾æ•£
            endTitle = "ã€ç»“å±€ï¼šé€‰æ‹©ä½ ã€‘";
            endText = "ä½ æ”¾å¼ƒæœ€çŸ­è·¯çº¿ã€‚ä¸æ˜¯å› ä¸ºè§„åˆ™ï¼Œæ˜¯å› ä¸ºâ€”â€”ä½ ä¸æƒ³å¤±å»ä»–ã€‚<br>é«˜åº¦æ‹‰å¼€ï¼Œä¹±æµé€€å»ï¼Œäº‘å±‚è£‚å¼€ä¸€é“å£å­ï¼Œå…‰è¿›æ¥ã€‚<br><br>ä¸‹æœºå‰ï¼Œä»–å›å¤´çœ‹äº†ä½ ä¸€çœ¼ã€‚<br>é‚£ä¸æ˜¯æ„Ÿè°¢ã€‚<br>æ˜¯ä¸€å¥æ²¡è¯´å‡ºå£çš„ï¼š<br><span style='color:#f1c40f'>â€œä¸‹æ¬¡ï¼Œè¿˜åä½ ã€‚â€</span>";
        } else {
            // ğŸ’” ç»“å±€äºŒï¼šå› çˆ±ç”Ÿæ¨ / å…±çŠ¯
            bgEl.style.backgroundImage = `url('${ASSETS.bg_white}')`; // ç™½å…‰/æ¶ˆå¤±
            fogEl.style.animation = "none"; // å†»ç»“
            endTitle = "ã€ç»“å±€ï¼šé›¾ä¸­ä¿¡å·ã€‘";
            endText = "ä½ æ²¡æœ‰ç»•è¡Œã€‚ä½ æŠŠæ€§èƒ½å‹åˆ°æé™ã€‚<br>æ¨ä»–æŠŠâ€œè¢«é€‰æ‹©â€çš„é‡é‡äº¤ç»™ä½ ã€‚æ¨ä»–è®©ä½ æ— æ³•åªåšä¸€å°æœºå™¨ã€‚<br><br>ä½†ä½ ä¹ŸçŸ¥é“â€”â€”å¦‚æœç°åœ¨æ”¾æ‰‹ï¼Œä½ ä¼šä¸€è¾ˆå­åœåœ¨ä»–æ²¡å›å¤´çš„é‚£ä¸€åˆ»ã€‚<br>äºæ˜¯ä½ ç»§ç»­é£ã€‚ä¸æ˜¯å è½ï¼Œæ˜¯ç¦»å¼€ã€‚<br><br>å¦‚æœæœ‰äººé—®èµ·é‚£å¤©æ—©ä¸Šçš„èˆªç­ï¼Œè®°å½•ä¼šæ˜¾ç¤ºï¼š<br><span style='color:#e74c3c'>ä¿¡å·æ¶ˆå¤±åœ¨é›¾ä¸­ã€‚</span><br>é‚£ä¸æ˜¯äº‹æ•…ï¼Œé‚£æ˜¯ä¸€æ¬¡è°ä¹Ÿä¸è‚¯å…ˆæ¾æ‰‹çš„çˆ±ã€‚";
        }

        textContentEl.innerHTML = `<h3 style='color:#f1c40f'>${endTitle}</h3><p>${endText}</p>`;
        
        markWorldCleared("world4");

        setTimeout(() => {
            const returnBtn = document.createElement('button');
            returnBtn.className = 'choice-btn return-btn';
            returnBtn.innerText = "ä¸–ç•Œçº¿æ”¶æŸ Â· è¿”å›ä¸­è½¬ç«™";
            returnBtn.onclick = () => {
                window.location.href = './index.html?skipIntro=true';
            };
            textContentEl.appendChild(returnBtn);
        }, 3000);
    }

    function markWorldCleared(worldId) {
        const SAVE_KEY = "reborn_game_cleared_worlds";
        let clearedWorlds = JSON.parse(localStorage.getItem(SAVE_KEY)) || [];
        if (!clearedWorlds.includes(worldId)) {
            clearedWorlds.push(worldId);
            localStorage.setItem(SAVE_KEY, JSON.stringify(clearedWorlds));
        }
    }

    function typeWriter(htmlText, targetElement) {
        isTyping = true;
        let fullText = htmlText;
        targetElement.innerHTML = '';
        let i = 0;
        clearInterval(typeInterval);
        
        typeInterval = setInterval(() => {
            if (i >= fullText.length) { finishTyping(); return; }
            if (fullText[i] === '<') {
                const closeIndex = fullText.indexOf('>', i);
                targetElement.innerHTML += fullText.substring(i, closeIndex + 1);
                i = closeIndex + 1;
            } else {
                targetElement.innerHTML += fullText[i];
                i++;
            }
        }, 40);
    }

    function finishTyping() {
        clearInterval(typeInterval);
        isTyping = false;
    }

    // å¯åŠ¨
    nextStep();

</script>
</body>
</html>
