<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯çº¿äºŒï¼šæµ·åº• Â· æ²‰é»˜çš„é‚»å±…</title>
    <style>
        /* --- å…¨å±€æ ·å¼ (æ·±æµ·å†·è‰²è°ƒ) --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #0d1b2a; /* æ·±æµ·è“é»‘ */
            font-family: "Microsoft YaHei", "SimHei", sans-serif;
            overflow: hidden;
            color: #bdc3c7; /* ç°ç™½è‰²æ–‡å­— */
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
        }

        #background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: opacity 2s ease, filter 2s ease;
            opacity: 0;
            filter: grayscale(30%); /* ç”»é¢è‡ªå¸¦ä¸€ç‚¹ç°åº¦ï¼Œä½“ç°å‹æŠ‘ */
        }

        /* è§’è‰²ç«‹ç»˜ */
        #character {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 80%;
            width: auto;
            z-index: 2;
            transition: opacity 1.5s ease;
            opacity: 0;
        }
        
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 5;
            pointer-events: none;
            transition: opacity 1.5s;
        }

        /* å¯¹è¯æ¡† (å†·è‰²ç³») */
        #dialogue-box {
            position: relative;
            width: 90%;
            max-width: 1000px;
            height: 260px;
            /* è“ç°è‰²æ¸å˜ */
            background: linear-gradient(180deg, rgba(13, 27, 42, 0) 0%, rgba(13, 27, 42, 0.95) 20%, rgba(5, 10, 15, 1) 100%);
            z-index: 10;
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            margin-bottom: 20px;
            border-top: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #name-tag {
            font-size: 24px;
            font-weight: bold;
            color: #f1c40f; /* ç™¾æ´å¸ƒå®å®çš„åå­—ç”¨é»„è‰² */
            margin-bottom: 15px;
            text-shadow: 0 0 5px rgba(241, 196, 15, 0.3);
        }

        #text-content {
            font-size: 20px;
            line-height: 1.7;
            letter-spacing: 1px;
            color: #ecf0f1;
        }

        /* ç³»ç»Ÿæç¤ºæ¡† (é’è‰²ç§‘æŠ€æ„Ÿ) */
        .system-message-container {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            background: rgba(13, 27, 42, 0.95);
            border: 1px solid #1abc9c; /* é’è‰² */
            box-shadow: 0 0 15px rgba(26, 188, 156, 0.2);
            color: #1abc9c;
            padding: 25px;
            text-align: center;
            z-index: 20;
            font-family: "Courier New", monospace;
            display: none;
        }

        /* é€‰é¡¹æ ·å¼ (æç®€é£æ ¼) */
        #choices-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7); /* ç¨å¾®é€šé€ä¸€ç‚¹ */
            z-index: 30;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .choice-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #7f8c8d;
            color: #bdc3c7;
            padding: 18px 40px;
            font-size: 19px;
            cursor: pointer;
            width: 65%;
            max-width: 450px;
            transition: all 0.4s;
            text-align: center;
        }

        .choice-btn:hover {
            background: #fff;
            color: #000;
            border-color: #fff;
            transform: scale(1.02);
        }

        #click-catcher {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 25;
            cursor: pointer;
        }
        
        .return-btn {
            margin-top: 30px;
            background: #1abc9c;
            color: #000;
            border: none;
            font-weight: bold;
        }
        .return-btn:hover {
            background: #16a085;
        }

    </style>
</head>
<body>

<div id="game-container">
    <div id="background"></div>
    <img id="character" src="" alt="Character">
    <div id="overlay"></div>

    <div id="system-box" class="system-message-container">
        <div id="system-content" class="system-text"></div>
    </div>

    <div id="choices-container"></div>

    <div id="dialogue-box">
        <div id="name-tag"></div>
        <div id="text-content"></div>
    </div>

    <div id="click-catcher" onclick="nextStep()"></div>
</div>

<script>
    // --- æ¸¸æˆçŠ¶æ€ ---
    let currentStepIndex = 0;
    let isTyping = false;
    let typeInterval;
    
    // æ ¸å¿ƒæ•°å€¼ï¼šAcknowledge (é¢å¯¹/æ‰¿è®¤) vs Deny (å¦è®¤/é€ƒé¿)
    let scores = {
        acknowledge: 0,
        deny: 0
    };

    // --- èµ„æºè·¯å¾„ (è¯·æ›¿æ¢å›¾ç‰‡) ---
    const ASSETS = {
        bg_cashier: './images2/bgcashier.png', // èŸ¹å ¡ç‹æ”¶é“¶å°
        bg_street: './images2/bgstreet.png',   // é»„æ˜è¡—é“
        bg_storm: './images2/bgstorm.png',     // æš´é›¨å¤œ
        bg_calm: './images2/bgcalm.png',       // é›¨å
        char_sb: './images2/charspongebaby.png' // ç™¾æ´å¸ƒbaby
    };

    // --- å‰§æœ¬ ---
    const storyScript = [
        // â–¶ W02-Scene 0ï½œè¿›å…¥
        { type: 'system', text: "è½¬ç”Ÿè·¯å¾„ç¡®è®¤ä¸­â€¦â€¦" },
        { type: 'system', text: "å½“å‰èº«ä»½ï¼šå·²åˆ†é…ã€‚\nè®°å¿†é™åˆ¶ï¼šå¯ç”¨ã€‚" },
        { type: 'system', text: "è½¬ç”Ÿå®Œæˆã€‚", bgAction: 'fadeIn', bgSrc: ASSETS.bg_cashier },

        // â–¶ W02-Scene 1ï½œæ—¥å¸¸ Â· é‡å¤
        { type: 'narrative', text: "æˆ‘ååœ¨æŸœå°åé¢ã€‚\næ‰‹é‡Œæ²¡æœ‰äº‹åšã€‚" },
        { type: 'narrative', text: "æ—¶é—´åœ¨æµåŠ¨ã€‚\nä½†ä¸æ˜æ˜¾ã€‚" },
        { type: 'narrative', text: "æœ‰äººåœ¨ç¬‘ã€‚\nå£°éŸ³ä»è¿œå¤„ä¼ æ¥ã€‚" },
        { type: 'narrative', text: "æˆ‘çŸ¥é“æ˜¯è°ã€‚\næˆ‘ç”šè‡³ä¸ç”¨å›å¤´ã€‚" },
        { type: 'system', text: "å½“å‰çŠ¶æ€ï¼šç¨³å®šã€‚" },

        // ğŸ”¹ Choice 1
        { 
            type: 'choice',
            question: "ã€ç¬¬ä¸€ååº”ã€‘é‚£ä¸ªç¬‘å£°â€¦â€¦",
            choices: [
                { text: "A. çƒ¦èº", effect: { deny: 1 } },
                { text: "B. æ— è§†", effect: { deny: 1 } },
                { text: "C. ç­‰å¾…å®ƒåœä¸‹", effect: { ack: 1 } }
            ]
        },
        { type: 'system', text: "è¾“å…¥å·²æ¥æ”¶ã€‚" },

        // â–¶ W02-Scene 2ï½œä»–é è¿‘äº†
        { type: 'narrative', text: "ä»–ç«™åœ¨æŸœå°å‰ã€‚\nå¤ªè¿‘äº†ã€‚", charAction: 'show', charSrc: ASSETS.char_sb },
        { type: 'dialogue', name: 'ç™¾æ´å¸ƒbaby', text: "ä»Šå¤©å¥½åƒæœ‰ç‚¹å®‰é™å‘¢ã€‚" },
        { type: 'narrative', text: "æˆ‘æ²¡æœ‰ç«‹åˆ»å›ç­”ã€‚" },
        { type: 'narrative', text: "ä¸æ˜¯å› ä¸ºæ²¡å¬è§ã€‚\nè€Œæ˜¯å› ä¸ºâ€”â€”\næˆ‘åœ¨ç­‰ä»–è¯´ä¸‹ä¸€å¥ã€‚" },

        // ğŸ”¹ Choice 2
        { 
            type: 'choice',
            question: "ã€å›åº”æ–¹å¼ã€‘ä½ ä¼šæ€ä¹ˆåšï¼Ÿ",
            choices: [
                { text: "A. å†·æ·¡å›åº”ï¼ˆç»§ç»­çœ‹æ‚å¿—ï¼‰", effect: { deny: 1 } },
                { text: "B. æ•·è¡ç©ç¬‘ï¼ˆæŠŠä»–æ‰“å‘èµ°ï¼‰", effect: { deny: 1 } },
                { text: "C. ç®€çŸ­å›åº”ï¼Œä½†æ²¡èµ¶ä»–èµ°", effect: { ack: 1 } }
            ]
        },
        { type: 'system', text: "è¡Œä¸ºè®°å½•ä¸­â€¦â€¦" },

        // â–¶ W02-Scene 3ï½œä¾èµ–æµ®ç°
        { type: 'narrative', text: "ä¸‹ç­åï¼Œæˆ‘èµ°åœ¨å›å®¶çš„è·¯ä¸Šã€‚", bgAction: 'change', bgSrc: ASSETS.bg_street, charAction: 'hide' },
        { type: 'narrative', text: "å¾ˆå®‰é™ã€‚\nå®‰é™å¾—â€”â€”\næœ‰ç‚¹ä¸å¯¹åŠ²ã€‚" },
        { type: 'narrative', text: "æˆ‘åœä¸‹è„šæ­¥ã€‚\næˆ‘åœ¨æƒ³ï¼š\nä»–ä»Šå¤©ï¼Œä¸ºä»€ä¹ˆæ²¡å†è¯´è¯ï¼Ÿ" },

        // ğŸ”¹ Choice 3
        { 
            type: 'choice',
            question: "ã€å†…çœã€‘ä½ æ„è¯†åˆ°è‡ªå·±åœ¨æ„è¿™ä»½å®‰é™ã€‚",
            choices: [
                { text: "A. ç«‹åˆ»å¦è®¤ï¼ˆæˆ‘åªæ˜¯ç´¯äº†ï¼‰", effect: { deny: 1 } },
                { text: "B. è¯´æœè‡ªå·±è¿™æ˜¯ä¹ æƒ¯", effect: { deny: 1 } },
                { text: "C. æ‰¿è®¤æœ‰ç‚¹å¤±è½", effect: { ack: 1 } }
            ]
        },
        { type: 'system', text: "è®°å½•å·²æ›´æ–°ã€‚" },

        // â–¶ W02-Scene 4ï½œæš´é£é›¨å¤œ Â· è¢«å›°
        { type: 'narrative', text: "é›¨å£°å‹ä½äº†ä¸€åˆ‡ã€‚", bgAction: 'change', bgSrc: ASSETS.bg_storm },
        { type: 'narrative', text: "é—¨å…³ä¸ä¸Šã€‚\nç”µé—ªäº†ä¸€ä¸‹ã€‚\nåªå‰©ä¸‹æˆ‘ä»¬ä¸¤ä¸ªã€‚", charAction: 'show', charSrc: ASSETS.char_sb },
        { type: 'narrative', text: "ä»–åœ¨æ•´ç†ä¸œè¥¿ã€‚\nåŠ¨ä½œå¾ˆæ…¢ã€‚\nåƒæ˜¯åœ¨åˆ»æ„æ‹–å»¶ã€‚" },

        // ğŸ”¹ Choice 4
        { 
            type: 'choice',
            question: "ã€å…±å¤„ã€‘åœ¨æš´é£é›¨ä¸­ï¼Œä½ ä¼šï¼Ÿ",
            choices: [
                { text: "A. æ˜ç¡®æ‹‰å¼€è·ç¦»", effect: { deny: 1 } },
                { text: "B. é»˜è®¸æ²‰é»˜å…±å¤„", effect: { ack: 1 } },
                { text: "C. ä¸»åŠ¨å¼€å£ï¼Œä½†åæ‚”", effect: { ack: 1, deny: 1 } }
            ]
        },
        { type: 'system', text: "è¾“å…¥å·²æ¥æ”¶ã€‚" },

        // â–¶ W02-Scene 5ï½œå¯¹è¯ä¸´ç•Œç‚¹
        { type: 'dialogue', name: 'ç™¾æ´å¸ƒbaby', text: "ä½ æ˜¯ä¸æ˜¯â€¦â€¦\nå…¶å®ä¸è®¨åŒæˆ‘ï¼Ÿ" },
        { type: 'narrative', text: "è¿™å¥è¯æ¥å¾—å¤ªçªç„¶ã€‚\næˆ‘æ²¡æœ‰å‡†å¤‡ç­”æ¡ˆã€‚" },

        // ğŸ”¹ Choice 5
        { 
            type: 'choice',
            question: "ã€å…³é”®æé—®ã€‘ä½ çš„å›ç­”æ˜¯ï¼Ÿ",
            choices: [
                { text: "A. å¦è®¤ï¼ˆä½ åœ¨èƒ¡è¯´ä»€ä¹ˆï¼‰", effect: { deny: 1 } },
                { text: "B. è½¬ç§»è¯é¢˜ï¼ˆé›¨åœäº†æˆ‘å°±èµ°ï¼‰", effect: { deny: 1 } },
                { text: "C. æ²‰é»˜", effect: { ack: 1 } }
            ]
        },
        { type: 'system', text: "è¾“å…¥å·²æ¥æ”¶ã€‚" },

        // â–¶ W02-Scene 6ï½œæœ€åä¸€åˆ»
        { type: 'narrative', text: "é£æš´åœäº†ã€‚", bgAction: 'change', bgSrc: ASSETS.bg_calm, charAction: 'hide' },
        { type: 'narrative', text: "é—¨å¯ä»¥æ‰“å¼€äº†ã€‚" },
        { type: 'narrative', text: "ä»–ç«™åœ¨é‚£å„¿ï¼Œ\nç­‰ä½ å…ˆèµ°ï¼Œ\nè¿˜æ˜¯å…ˆè¯´ã€‚" },
        { type: 'system', text: "å½“å‰è·¯å¾„å€¾å‘ï¼šå·²é”å®šã€‚" },

        // ğŸ”¹ Choice 6 (Final Attitude)
        { 
            type: 'choice',
            question: "ã€æœ€åæ—¶åˆ»ã€‘ä½ ä¼šç•™ä¸‹ä»€ä¹ˆï¼Ÿ",
            choices: [
                { text: "A. è¯´ä¸€å¥å¤šä½™çš„è¯ï¼ˆæ¯”å¦‚â€œæ˜å¤©è§â€ï¼‰", effect: { ack: 1 } },
                { text: "B. ä»€ä¹ˆéƒ½ä¸è¯´ï¼Œç›´æ¥ç¦»å¼€", effect: { deny: 1 } }
            ]
        },

        // ç»“å±€åˆ¤å®šç‚¹
        { type: 'logic_check' }
    ];

    // --- å¼•æ“é€»è¾‘ (å¤ç”¨ World 1 æ ¸å¿ƒ) ---
    const bgEl = document.getElementById('background');
    const charEl = document.getElementById('character');
    const overlayEl = document.getElementById('overlay');
    const nameTagEl = document.getElementById('name-tag');
    const textContentEl = document.getElementById('text-content');
    const dialogueBoxEl = document.getElementById('dialogue-box');
    const systemBoxEl = document.getElementById('system-box');
    const systemContentEl = document.getElementById('system-content');
    const choicesContainerEl = document.getElementById('choices-container');

    function nextStep() {
        if (isTyping) { finishTyping(); return; }
        if (currentStepIndex >= storyScript.length) return;

        const step = storyScript[currentStepIndex];

        if (step.type === 'logic_check') {
            resolveEnding();
            return;
        }

        handleEffects(step);

        if (step.type === 'choice') {
            showChoices(step);
        } else if (step.type === 'system') {
            showSystemMessage(step.text);
            currentStepIndex++;
        } else {
            showDialogue(step);
            currentStepIndex++;
        }
    }

    function handleEffects(step) {
        if (step.bgAction === 'fadeIn') {
            overlayEl.style.opacity = 0;
            bgEl.style.opacity = 1;
            if(step.bgSrc) bgEl.style.backgroundImage = `url('${step.bgSrc}')`;
        } else if (step.bgAction === 'change') {
            if(step.bgSrc) bgEl.style.backgroundImage = `url('${step.bgSrc}')`;
        }
        
        if (step.charAction === 'show') {
            charEl.style.opacity = 1;
            if(step.charSrc) charEl.src = step.charSrc;
        } else if (step.charAction === 'hide') {
            charEl.style.opacity = 0;
        }
    }

    function showDialogue(step) {
        systemBoxEl.style.display = 'none';
        dialogueBoxEl.style.opacity = 1;
        
        if (step.name) {
            nameTagEl.innerText = step.name;
            nameTagEl.style.display = 'block';
        } else {
            nameTagEl.style.display = 'none';
        }
        typeWriter(step.text.replace(/\n/g, '<br>'), textContentEl);
    }

    function showSystemMessage(text) {
        dialogueBoxEl.style.opacity = 0;
        systemBoxEl.style.display = 'block';
        typeWriter(text, systemContentEl);
    }

    function showChoices(step) {
        choicesContainerEl.style.display = 'flex';
        choicesContainerEl.innerHTML = '';
        
        const title = document.createElement('h2');
        title.innerText = step.question;
        title.style.color = '#bdc3c7';
        title.style.marginBottom = '20px';
        choicesContainerEl.appendChild(title);

        step.choices.forEach(choice => {
            const btn = document.createElement('div');
            btn.className = 'choice-btn';
            btn.innerText = choice.text;
            btn.onclick = (e) => {
                e.stopPropagation();
                if (choice.effect) {
                    if (choice.effect.ack) scores.acknowledge += choice.effect.ack;
                    if (choice.effect.deny) scores.deny += choice.effect.deny;
                }
                choicesContainerEl.style.display = 'none';
                currentStepIndex++;
                nextStep();
            };
            choicesContainerEl.appendChild(btn);
        });
    }

    function resolveEnding() {
        dialogueBoxEl.style.opacity = 1;
        nameTagEl.style.display = 'none';
        systemBoxEl.style.display = 'none';
        
        let endTitle = "";
        let endText = "";

        // ç»“å±€åˆ¤å®š
        if (scores.acknowledge > scores.deny) {
            // âœ… å¦ç™½ç»“å±€
            endTitle = "ã€ç»“å±€ï¼šä¸€èµ·å®‰é™ã€‘";
            endText = "æ²¡æœ‰å¤§å£°è¯´ä»€ä¹ˆã€‚<br>åªæ˜¯ç«™å¾—è¿‘äº†ä¸€ç‚¹ã€‚<br>åœ¨è¿™ä¸ªæ°¸è¿œåµé—¹çš„åœ°æ–¹ï¼Œ<br>ä½ ä»¬ç»ˆäºå­¦ä¼šäº†<br><span style='color:#1abc9c'>ä¸€èµ·å®‰é™ã€‚</span>";
        } else {
            // âŒ æ²‰é»˜ç»“å±€
            endTitle = "ã€ç»“å±€ï¼šç»§ç»­æ²‰æ²¡ã€‘";
            endText = "ä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿã€‚<br>æ‰€ä»¥ä¸€åˆ‡éƒ½ä¼šç»§ç»­ã€‚<br>åªæ˜¯ä»¥åï¼Œ<br>ä½ å†ä¹Ÿæ²¡æœ‰ç­‰è¿‡<br>é‚£é“å£°éŸ³ã€‚";
        }

        textContentEl.innerHTML = `<h3 style='color:#f1c40f'>${endTitle}</h3><p>${endText}</p>`;
        
        markWorldCleared("world2"); // æ ‡è®° World 2 é€šå…³

        setTimeout(() => {
            const returnBtn = document.createElement('button');
            returnBtn.className = 'choice-btn return-btn';
            returnBtn.innerText = "ä¸–ç•Œçº¿æ”¶æŸ Â· è¿”å›ä¸­è½¬ç«™";
            returnBtn.onclick = () => {
                // å¸¦ä¸Š skipIntro=true å‚æ•°ï¼Œå›ä¸»é¡µä¸çœ‹ç‰‡å¤´
                window.location.href = 'index.html?skipIntro=true';
            };
            textContentEl.appendChild(returnBtn);
        }, 1500);
    }

    function markWorldCleared(worldId) {
        const SAVE_KEY = "reborn_game_cleared_worlds";
        let clearedWorlds = JSON.parse(localStorage.getItem(SAVE_KEY)) || [];
        if (!clearedWorlds.includes(worldId)) {
            clearedWorlds.push(worldId);
            localStorage.setItem(SAVE_KEY, JSON.stringify(clearedWorlds));
        }
    }

    function typeWriter(htmlText, targetElement) {
        isTyping = true;
        let fullText = htmlText;
        targetElement.innerHTML = '';
        let i = 0;
        clearInterval(typeInterval);
        
        typeInterval = setInterval(() => {
            if (i >= fullText.length) { finishTyping(); return; }
            if (fullText[i] === '<') {
                const closeIndex = fullText.indexOf('>', i);
                targetElement.innerHTML += fullText.substring(i, closeIndex + 1);
                i = closeIndex + 1;
            } else {
                targetElement.innerHTML += fullText[i];
                i++;
            }
        }, 40);
    }

    function finishTyping() {
        clearInterval(typeInterval);
        isTyping = false;
    }

    // å¯åŠ¨
    nextStep();

</script>
</body>
</html>
